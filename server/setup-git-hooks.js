/**
 * è®¾ç½® Git Hooks ä»¥é˜²æ­¢å¯†é’¥æ³„éœ²
 */

import fs from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import { execSync } from 'child_process';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const projectRoot = join(__dirname, '..');
const gitHooksDir = join(projectRoot, '.git', 'hooks');
const preCommitHook = join(gitHooksDir, 'pre-commit');

console.log('\nğŸ”§ è®¾ç½® Git Hooks é˜²æ­¢å¯†é’¥æ³„éœ²\n');
console.log('='.repeat(70));

// æ£€æŸ¥æ˜¯å¦æ˜¯ Git ä»“åº“
if (!fs.existsSync(join(projectRoot, '.git'))) {
  console.error('\nâŒ é”™è¯¯: è¿™ä¸æ˜¯ä¸€ä¸ª Git ä»“åº“');
  console.error('ğŸ’¡ è¯·å…ˆè¿è¡Œ: git init\n');
  process.exit(1);
}

// Pre-commit hook è„šæœ¬
const preCommitScript = `#!/bin/bash
# Pre-commit hook to prevent committing sensitive files
# Auto-generated by setup-git-hooks.js

echo "ğŸ” æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶..."

# æ£€æŸ¥æ˜¯å¦è¦æäº¤ .env æ–‡ä»¶
if git diff --cached --name-only | grep -qE "\\.env$"; then
    echo ""
    echo "âŒ é”™è¯¯: å°è¯•æäº¤ .env æ–‡ä»¶ï¼"
    echo "ğŸ’¡ .env æ–‡ä»¶åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œä¸åº”æäº¤åˆ° Git"
    echo ""
    echo "å¦‚æœè¿™æ˜¯ .env.example æ–‡ä»¶ï¼Œè¯·ç¡®ä¿æ–‡ä»¶åæ­£ç¡®"
    echo ""
    exit 1
fi

# æ£€æŸ¥æ˜¯å¦åŒ…å« Google API å¯†é’¥
if git diff --cached | grep -qE "AIzaSy[0-9A-Za-z_-]{33}"; then
    echo ""
    echo "âŒ é”™è¯¯: æ£€æµ‹åˆ° Google API å¯†é’¥ï¼"
    echo "ğŸ’¡ è¯·ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç  API å¯†é’¥"
    echo "ğŸ’¡ ä½¿ç”¨ç¯å¢ƒå˜é‡: process.env.GOOGLE_API_KEY"
    echo ""
    exit 1
fi

# æ£€æŸ¥æ˜¯å¦åŒ…å« Cloudflare API Token
if git diff --cached | grep -qE "[A-Za-z0-9_-]{40}"; then
    # è¿›ä¸€æ­¥æ£€æŸ¥æ˜¯å¦åœ¨ .env ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¸­
    if git diff --cached | grep -qE "(CLOUDFLARE_API_TOKEN|API.*TOKEN).*=.*[A-Za-z0-9_-]{40}"; then
        echo ""
        echo "âš ï¸  è­¦å‘Š: å¯èƒ½æ£€æµ‹åˆ° API Token"
        echo "ğŸ’¡ è¯·ç¡®è®¤æ²¡æœ‰ç¡¬ç¼–ç  API å¯†é’¥"
        echo ""
        # ä¸é˜»æ­¢æäº¤ï¼Œåªæ˜¯è­¦å‘Š
    fi
fi

# æ£€æŸ¥æ˜¯å¦åŒ…å«å…¶ä»–å¸¸è§å¯†é’¥æ ¼å¼
if git diff --cached | grep -qE "(api[_-]?key|api[_-]?secret|password|token).*=.*['\"][^'\"]{20,}['\"]"; then
    echo ""
    echo "âš ï¸  è­¦å‘Š: æ£€æµ‹åˆ°å¯èƒ½çš„å¯†é’¥æˆ–å¯†ç "
    echo "ğŸ’¡ è¯·ç¡®è®¤è¿™ä¸æ˜¯çœŸå®çš„å¯†é’¥"
    echo ""
    # ä¸é˜»æ­¢æäº¤ï¼Œåªæ˜¯è­¦å‘Š
fi

echo "âœ… Pre-commit æ£€æŸ¥é€šè¿‡"
exit 0
`;

try {
  // åˆ›å»º hooks ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  if (!fs.existsSync(gitHooksDir)) {
    fs.mkdirSync(gitHooksDir, { recursive: true });
  }

  // å†™å…¥ pre-commit hook
  fs.writeFileSync(preCommitHook, preCommitScript, { mode: 0o755 });

  // åœ¨ Windows ä¸Šï¼Œéœ€è¦ç¡®ä¿æ–‡ä»¶å¯æ‰§è¡Œ
  if (process.platform === 'win32') {
    console.log('\nğŸ“ Windows ç³»ç»Ÿæ£€æµ‹åˆ°');
    console.log('   Pre-commit hook å·²åˆ›å»ºï¼Œä½†å¯èƒ½éœ€è¦ Git Bash æ‰èƒ½è¿è¡Œ');
  } else {
    // Unix ç³»ç»Ÿï¼Œè®¾ç½®å¯æ‰§è¡Œæƒé™
    try {
      execSync(`chmod +x "${preCommitHook}"`);
    } catch (error) {
      console.warn('âš ï¸  æ— æ³•è®¾ç½®å¯æ‰§è¡Œæƒé™ï¼Œè¯·æ‰‹åŠ¨è¿è¡Œ:');
      console.warn(`   chmod +x .git/hooks/pre-commit`);
    }
  }

  console.log('\nâœ… Git Hooks è®¾ç½®æˆåŠŸï¼');
  console.log('\nğŸ“‹ å·²å®‰è£…çš„ Hooks:');
  console.log('   âœ… pre-commit - é˜²æ­¢æäº¤æ•æ„Ÿæ–‡ä»¶');
  
  console.log('\nğŸ” æ£€æµ‹è§„åˆ™:');
  console.log('   1. é˜»æ­¢æäº¤ .env æ–‡ä»¶');
  console.log('   2. æ£€æµ‹ Google API å¯†é’¥æ ¼å¼');
  console.log('   3. è­¦å‘Šå¯èƒ½çš„ API Token');
  console.log('   4. è­¦å‘Šå¯èƒ½çš„å¯†ç æˆ–å¯†é’¥');
  
  console.log('\nğŸ§ª æµ‹è¯• Hook:');
  console.log('   # å°è¯•æäº¤ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶');
  console.log('   echo "test" > test.txt');
  console.log('   git add test.txt');
  console.log('   git commit -m "test"');
  console.log('   # åº”è¯¥çœ‹åˆ°: âœ… Pre-commit æ£€æŸ¥é€šè¿‡');
  
  console.log('\nğŸ’¡ æç¤º:');
  console.log('   - Hook ä¼šåœ¨æ¯æ¬¡ git commit æ—¶è‡ªåŠ¨è¿è¡Œ');
  console.log('   - å¦‚æœæ£€æµ‹åˆ°é—®é¢˜ï¼Œæäº¤ä¼šè¢«é˜»æ­¢');
  console.log('   - å¯ä»¥ä½¿ç”¨ --no-verify è·³è¿‡æ£€æŸ¥ï¼ˆä¸æ¨èï¼‰');
  
  console.log('\n' + '='.repeat(70) + '\n');

} catch (error) {
  console.error('\nâŒ é”™è¯¯:', error.message);
  console.error('\nğŸ’¡ è¯·æ‰‹åŠ¨åˆ›å»º pre-commit hook:');
  console.error(`   1. åˆ›å»ºæ–‡ä»¶: .git/hooks/pre-commit`);
  console.error(`   2. å¤åˆ¶ä¸Šé¢çš„è„šæœ¬å†…å®¹`);
  console.error(`   3. è®¾ç½®å¯æ‰§è¡Œæƒé™: chmod +x .git/hooks/pre-commit\n`);
  process.exit(1);
}

