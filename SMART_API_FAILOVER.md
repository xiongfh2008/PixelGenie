# ğŸ”„ æ™ºèƒ½APIæ•…éšœè½¬ç§»æœºåˆ¶

## ğŸ“‹ æ¦‚è¿°

å®ç°äº†ä¸€ä¸ªå®Œå…¨è‡ªåŠ¨åŒ–ã€å¯¹ç”¨æˆ·æ— æ„ŸçŸ¥çš„APIæ•…éšœè½¬ç§»ç³»ç»Ÿã€‚å½“æŸä¸ªAPIæä¾›å•†å‡ºç°å¼‚å¸¸æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æŒ‰ä¼˜å…ˆçº§åˆ‡æ¢åˆ°å…¶ä»–å¯ç”¨çš„æä¾›å•†ï¼Œç¡®ä¿æœåŠ¡çš„é«˜å¯ç”¨æ€§ã€‚

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### 1. ğŸ¯ è‡ªåŠ¨æ•…éšœè½¬ç§»
- å½“APIè¯·æ±‚å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨å°è¯•ä¸‹ä¸€ä¸ªå¯ç”¨çš„æä¾›å•†
- æ™ºèƒ½è·³è¿‡å·²ç»å¤±è´¥çš„æä¾›å•†
- æ”¯æŒå¤šæ¬¡é‡è¯•ï¼Œç›´åˆ°æˆåŠŸæˆ–è€—å°½æ‰€æœ‰é€‰é¡¹

### 2. ğŸ” æ™ºèƒ½å¥åº·æ£€æµ‹
- å®æ—¶ç›‘æ§æ¯ä¸ªAPIæä¾›å•†çš„å¥åº·çŠ¶æ€
- è‡ªåŠ¨æ ‡è®°ä¸å¥åº·çš„æä¾›å•†
- å®šæœŸå¥åº·æ£€æŸ¥ï¼Œè‡ªåŠ¨æ¢å¤å¥åº·çš„æä¾›å•†

### 3. âš¡ æŒ‡æ•°é€€é¿ç­–ç•¥
- å¤±è´¥åç­‰å¾…æ—¶é—´é€æ¸å¢åŠ 
- æ·»åŠ éšæœºæŠ–åŠ¨ï¼Œé¿å…é›·é¸£ç¾¤æ•ˆåº”
- æœ€å¤§ç­‰å¾…æ—¶é—´é™åˆ¶ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡

### 4. ğŸ“Š å®Œæ•´çš„äº‹ä»¶æ—¥å¿—
- è®°å½•æ¯æ¬¡è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯
- æˆåŠŸ/å¤±è´¥äº‹ä»¶åˆ†ç±»
- ä¾¿äºç›‘æ§å’Œé—®é¢˜æ’æŸ¥

### 5. ğŸ¨ å¯¹ç”¨æˆ·å®Œå…¨é€æ˜
- ç”¨æˆ·æ— éœ€å…³å¿ƒä½¿ç”¨å“ªä¸ªAPI
- è‡ªåŠ¨å¤„ç†æ‰€æœ‰æ•…éšœå’Œé‡è¯•
- è¿”å›ç»Ÿä¸€çš„å“åº”æ ¼å¼

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ç»„ä»¶å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç”¨æˆ·è¯·æ±‚ (User Request)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      æ™ºèƒ½APIè·¯ç”±å™¨ (Smart Router)        â”‚
â”‚  - é€‰æ‹©æœ€ä½³æä¾›å•†                         â”‚
â”‚  - æ‰§è¡Œè¯·æ±‚                              â”‚
â”‚  - å¤„ç†å¤±è´¥                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚          â”‚          â”‚
        â–¼          â–¼          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚Google  â”‚ â”‚Cloudfl.â”‚ â”‚HuggingFâ”‚
   â”‚Gemini  â”‚ â”‚Workers â”‚ â”‚  Face  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚          â”‚          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç»Ÿä¸€å“åº” (Unified Response)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•…éšœè½¬ç§»æµç¨‹

```
å¼€å§‹è¯·æ±‚
   â”‚
   â–¼
é€‰æ‹©APIæä¾›å•† (ä¼˜å…ˆçº§: Primary â†’ Backup â†’ Fallback)
   â”‚
   â–¼
æ‰§è¡ŒAPIè¯·æ±‚
   â”‚
   â”œâ”€æˆåŠŸâ”€â†’ æ›´æ–°å¥åº·çŠ¶æ€ â”€â†’ è¿”å›ç»“æœ â”€â†’ ç»“æŸ
   â”‚
   â”œâ”€å¤±è´¥â”€â†’ è®°å½•å¤±è´¥ â”€â†’ æ›´æ–°å¥åº·çŠ¶æ€
   â”‚           â”‚
   â”‚           â–¼
   â”‚      è¿˜æœ‰é‡è¯•æœºä¼šï¼Ÿ
   â”‚           â”‚
   â”‚       â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â”‚       â”‚       â”‚
   â”‚      æ˜¯      å¦
   â”‚       â”‚       â”‚
   â”‚       â–¼       â–¼
   â”‚    ç­‰å¾…åé‡è¯•  è¿”å›é”™è¯¯
   â”‚       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³• 1: ä½¿ç”¨æ™ºèƒ½APIåŒ…è£…å™¨ï¼ˆæ¨èï¼‰

```javascript
import { createApiWrapper } from './smart-api-router.js';

// åˆ›å»ºAPIåŒ…è£…å™¨
const apiWrapper = createApiWrapper({
  selectApiProvider,
  updateApiHealth,
  getApiKeys
});

// ä½¿ç”¨åŒ…è£…å™¨æ‰§è¡Œè¯·æ±‚
try {
  const result = await apiWrapper.analyzeImage(parts, 'imageAnalysis');
  
  // æˆåŠŸï¼resultåŒ…å«:
  // - success: true
  // - data: å®é™…çš„å“åº”æ•°æ®
  // - meta: { provider, attempts, attemptedProviders }
  
  res.json(result.data);
} catch (error) {
  // æ‰€æœ‰APIéƒ½å¤±è´¥äº†
  res.status(500).json({ error: error.message });
}
```

### æ–¹æ³• 2: ä½¿ç”¨åº•å±‚smartApiRequest

```javascript
import { smartApiRequest } from './smart-api-router.js';

const result = await smartApiRequest({
  selectApiProvider,
  updateApiHealth,
  capability: 'imageAnalysis',
  params: { parts },
  maxAttempts: 3,
  
  // æ„å»ºè¯·æ±‚
  buildRequest: (provider, params) => {
    // è¿”å› { url, requestBody, headers, provider }
  },
  
  // æ‰§è¡Œè¯·æ±‚
  executeRequest: async (config) => {
    // è¿”å› response
  },
  
  // è§£æå“åº”
  parseResponse: (response, provider) => {
    // è¿”å›è§£æåçš„æ•°æ®
  }
});
```

---

## ğŸ“ é›†æˆåˆ°ç°æœ‰ä»£ç 

### æ­¥éª¤ 1: å¯¼å…¥æ¨¡å—

```javascript
import { createApiWrapper } from './smart-api-router.js';
```

### æ­¥éª¤ 2: åˆ›å»ºåŒ…è£…å™¨å®ä¾‹

```javascript
const apiWrapper = createApiWrapper({
  selectApiProvider,
  updateApiHealth,
  getApiKeys
});
```

### æ­¥éª¤ 3: æ›¿æ¢ç°æœ‰çš„APIè°ƒç”¨

**ä¹‹å‰çš„ä»£ç **:
```javascript
app.post('/api/analyze-image', async (req, res) => {
  try {
    const provider = selectApiProvider('imageAnalysis');
    
    // æ„å»ºè¯·æ±‚...
    const response = await fetch(url, { ... });
    const data = await response.json();
    
    // è§£æå“åº”...
    res.json(result);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});
```

**ä½¿ç”¨æ™ºèƒ½è·¯ç”±å™¨å**:
```javascript
app.post('/api/analyze-image', async (req, res) => {
  try {
    const result = await apiWrapper.analyzeImage(parts, 'imageAnalysis');
    res.json(result.data);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});
```

---

## ğŸ”§ é…ç½®é€‰é¡¹

### maxAttempts (æœ€å¤§å°è¯•æ¬¡æ•°)

```javascript
const result = await smartApiRequest({
  // ... å…¶ä»–é…ç½®
  maxAttempts: 5  // é»˜è®¤: 3
});
```

### é€€é¿ç­–ç•¥

```javascript
// åœ¨ smart-api-router.js ä¸­é…ç½®
function calculateBackoff(attempt) {
  const baseDelay = 1000;  // åŸºç¡€å»¶è¿Ÿ: 1ç§’
  const maxDelay = 5000;   // æœ€å¤§å»¶è¿Ÿ: 5ç§’
  const delay = Math.min(baseDelay * Math.pow(2, attempt - 1), maxDelay);
  return delay + Math.random() * 1000;  // æ·»åŠ éšæœºæŠ–åŠ¨
}
```

### APIä¼˜å…ˆçº§

åœ¨ `selectApiProvider` å‡½æ•°ä¸­é…ç½®:

```javascript
const primaryProviders = ['google', 'xunfei'];        // ä¸»ç”¨
const backupProviders = ['cloudflare', 'huggingface']; // å¤‡ç”¨
const fallbackProviders = ['baidu', 'tencent'];        // åå¤‡
```

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### äº‹ä»¶ç±»å‹

1. **SUCCESS** - è¯·æ±‚æˆåŠŸ
   ```json
   {
     "type": "success",
     "provider": "google",
     "capability": "imageAnalysis",
     "attempt": 1,
     "totalAttempts": 1,
     "attemptedProviders": ["google"]
   }
   ```

2. **FAILURE** - å•æ¬¡è¯·æ±‚å¤±è´¥
   ```json
   {
     "type": "failure",
     "provider": "google",
     "capability": "imageAnalysis",
     "attempt": 1,
     "error": "API key leaked",
     "attemptedProviders": ["google"]
   }
   ```

3. **ALL_FAILED** - æ‰€æœ‰å°è¯•éƒ½å¤±è´¥
   ```json
   {
     "type": "all_failed",
     "attemptedProviders": ["google", "cloudflare", "huggingface"],
     "totalAttempts": 3,
     "lastError": "Network timeout",
     "capability": "imageAnalysis"
   }
   ```

### æ—¥å¿—è¾“å‡ºç¤ºä¾‹

```
ğŸ”„ Attempt 1/3: Using google for imageAnalysis
âœ… Success with google (attempt 1/3)
ğŸ“Š [SUCCESS] {"timestamp":"2025-11-26T...","type":"success",...}
```

```
ğŸ”„ Attempt 1/3: Using google for imageAnalysis
âŒ Attempt 1 failed with google: API key leaked
â³ Waiting 1234ms before next attempt...
ğŸ”„ Attempt 2/3: Using cloudflare for imageAnalysis
âœ… Success with cloudflare (attempt 2/3)
ğŸ“Š [SUCCESS] {"timestamp":"2025-11-26T...","type":"success",...}
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. åˆç†è®¾ç½®é‡è¯•æ¬¡æ•°

```javascript
// å¯¹äºå…³é”®åŠŸèƒ½ï¼Œå¢åŠ é‡è¯•æ¬¡æ•°
const result = await smartApiRequest({
  maxAttempts: 5,  // å›¾åƒåˆ†æç­‰å…³é”®åŠŸèƒ½
  // ...
});

// å¯¹äºéå…³é”®åŠŸèƒ½ï¼Œå‡å°‘é‡è¯•æ¬¡æ•°
const result = await smartApiRequest({
  maxAttempts: 2,  // æ—¥å¿—è®°å½•ç­‰éå…³é”®åŠŸèƒ½
  // ...
});
```

### 2. é…ç½®åˆé€‚çš„è¶…æ—¶æ—¶é—´

```javascript
executeRequest: async ({ url, requestBody, headers }) => {
  const response = await fetch(url, {
    method: 'POST',
    headers,
    body: JSON.stringify(requestBody),
    signal: AbortSignal.timeout(30000)  // 30ç§’è¶…æ—¶
  });
  return response.json();
}
```

### 3. å¤„ç†ä¸åŒç±»å‹çš„é”™è¯¯

```javascript
parseResponse: (data, provider) => {
  // éªŒè¯å“åº”æ ¼å¼
  if (!data || !data.result) {
    throw new Error('Invalid response format');
  }
  
  // æ£€æŸ¥ä¸šåŠ¡é”™è¯¯
  if (data.error) {
    throw new Error(data.error.message);
  }
  
  return data.result;
}
```

### 4. è®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

```javascript
catch (error) {
  console.error('API request failed:', {
    error: error.message,
    stack: error.stack,
    attemptedProviders,
    capability
  });
}
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æ‰€æœ‰APIéƒ½å¤±è´¥

**ç—‡çŠ¶**: æ”¶åˆ° "All API providers failed" é”™è¯¯

**æ£€æŸ¥**:
1. æŸ¥çœ‹æ—¥å¿—ä¸­çš„ `attemptedProviders`
2. æ£€æŸ¥æ¯ä¸ªæä¾›å•†çš„å¥åº·çŠ¶æ€
3. éªŒè¯APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ
4. æ£€æŸ¥ç½‘ç»œè¿æ¥

**è§£å†³**:
```bash
# æ£€æŸ¥APIå¥åº·çŠ¶æ€
curl http://localhost:3001/api/health

# æ‰‹åŠ¨æµ‹è¯•API
cd server && node test-cloudflare.js
```

### é—®é¢˜ 2: é¢‘ç¹åˆ‡æ¢æä¾›å•†

**ç—‡çŠ¶**: æ—¥å¿—æ˜¾ç¤ºé¢‘ç¹çš„æ•…éšœè½¬ç§»

**åŸå› **:
- APIé…é¢ç”¨å®Œ
- APIå¯†é’¥æ— æ•ˆ
- ç½‘ç»œä¸ç¨³å®š

**è§£å†³**:
1. æ£€æŸ¥APIä½¿ç”¨é‡
2. æ›´æ–°APIå¯†é’¥
3. å¢åŠ é‡è¯•å»¶è¿Ÿ

### é—®é¢˜ 3: å“åº”æ—¶é—´è¿‡é•¿

**ç—‡çŠ¶**: è¯·æ±‚éœ€è¦å¾ˆé•¿æ—¶é—´æ‰è¿”å›

**åŸå› **:
- å¤šæ¬¡é‡è¯•å¯¼è‡´
- é€€é¿æ—¶é—´è¿‡é•¿

**è§£å†³**:
```javascript
// å‡å°‘æœ€å¤§å°è¯•æ¬¡æ•°
maxAttempts: 2

// æˆ–è°ƒæ•´é€€é¿ç­–ç•¥
function calculateBackoff(attempt) {
  return 500 * attempt;  // æ›´çŸ­çš„å»¶è¿Ÿ
}
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. å¹¶è¡Œå¥åº·æ£€æŸ¥

```javascript
// å®šæœŸå¹¶è¡Œæ£€æŸ¥æ‰€æœ‰APIçš„å¥åº·çŠ¶æ€
async function checkAllProviders() {
  const providers = ['google', 'cloudflare', 'huggingface'];
  await Promise.all(
    providers.map(p => checkApiHealth(p, apiKeys[p]))
  );
}
```

### 2. ç¼“å­˜APIå“åº”

```javascript
const cache = new Map();

parseResponse: (data, provider) => {
  const cacheKey = JSON.stringify(params);
  if (cache.has(cacheKey)) {
    return cache.get(cacheKey);
  }
  const result = parseData(data);
  cache.set(cacheKey, result);
  return result;
}
```

### 3. é¢„çƒ­APIè¿æ¥

```javascript
// æœåŠ¡å™¨å¯åŠ¨æ—¶é¢„çƒ­è¿æ¥
async function warmupConnections() {
  const providers = ['google', 'cloudflare'];
  for (const provider of providers) {
    try {
      await checkApiHealth(provider, apiKeys[provider]);
    } catch (error) {
      console.warn(`Warmup failed for ${provider}`);
    }
  }
}
```

---

## ğŸŠ æ€»ç»“

### ä¼˜åŠ¿

âœ… **é«˜å¯ç”¨æ€§** - è‡ªåŠ¨æ•…éšœè½¬ç§»ç¡®ä¿æœåŠ¡æŒç»­å¯ç”¨  
âœ… **ç”¨æˆ·æ— æ„ŸçŸ¥** - æ‰€æœ‰é‡è¯•å’Œåˆ‡æ¢å¯¹ç”¨æˆ·é€æ˜  
âœ… **æ™ºèƒ½è·¯ç”±** - æ ¹æ®å¥åº·çŠ¶æ€å’Œèƒ½åŠ›é€‰æ‹©æœ€ä½³API  
âœ… **å®Œæ•´æ—¥å¿—** - ä¾¿äºç›‘æ§å’Œé—®é¢˜æ’æŸ¥  
âœ… **æ˜“äºé›†æˆ** - ç®€å•çš„APIï¼Œå¿«é€Ÿé›†æˆåˆ°ç°æœ‰ä»£ç   

### ä½¿ç”¨åœºæ™¯

- ğŸ–¼ï¸ å›¾åƒåˆ†æå’Œå¤„ç†
- ğŸ“ æ–‡æœ¬ç¿»è¯‘
- ğŸ¨ å›¾åƒç”Ÿæˆå’Œç¼–è¾‘
- ğŸ” AIæ£€æµ‹
- ğŸ“Š ä»»ä½•éœ€è¦é«˜å¯ç”¨æ€§çš„APIè°ƒç”¨

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `server/smart-api-router.js` - æ™ºèƒ½è·¯ç”±å™¨å®ç°
- `server/api-failover.js` - æ•…éšœè½¬ç§»å·¥å…·å‡½æ•°
- `server/index.js` - ä¸»æœåŠ¡å™¨æ–‡ä»¶
- `GOOGLE_API_RESTORED.md` - APIé…ç½®æŒ‡å—

---

**ç°åœ¨æ‚¨çš„APIè°ƒç”¨æ‹¥æœ‰ä¼ä¸šçº§çš„å¯é æ€§ï¼** ğŸš€

