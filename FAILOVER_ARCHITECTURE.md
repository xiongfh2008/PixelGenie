# 🏗️ 智能故障转移系统架构

## 📐 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户请求                                  │
│                    (前端 React 应用)                              │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Express 服务器                                 │
│                   (server/index.js)                              │
├─────────────────────────────────────────────────────────────────┤
│  API 端点:                                                        │
│  • POST /api/analyze-image      (智能鉴伪)                       │
│  • POST /api/modify-image       (去水印)                         │
│  • POST /api/translate-image-text (翻译)                         │
│  • GET  /api/health-report      (健康状态)                       │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              故障转移包装器 (api-failover.js)                     │
├─────────────────────────────────────────────────────────────────┤
│  callWithFailover(apiFunction, capability, params, maxRetries)  │
│                                                                   │
│  功能:                                                            │
│  • 自动重试逻辑                                                   │
│  • 提供商切换                                                     │
│  • 超时控制                                                       │
│  • 响应解析                                                       │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│            健康状态管理器 (api-health.js)                         │
├─────────────────────────────────────────────────────────────────┤
│  selectApiProvider(capability, excludeProviders)                │
│  updateApiHealth(provider, isHealthy, error)                    │
│  getHealthReport()                                               │
│                                                                   │
│  跟踪:                                                            │
│  • 提供商健康状态                                                 │
│  • 错误计数                                                       │
│  • 密钥泄露检测                                                   │
│  • 能力匹配                                                       │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    API 提供商选择                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  主用提供商 (优先级 1)                                            │
│  ┌──────────┐  ┌──────────┐                                     │
│  │  Google  │  │  讯飞    │                                     │
│  └──────────┘  └──────────┘                                     │
│                                                                   │
│  备用提供商 (优先级 2)                                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                      │
│  │Cloudflare│  │HuggingFace│ │ DeepSeek │                      │
│  └──────────┘  └──────────┘  └──────────┘                      │
│                                                                   │
│  后备提供商 (优先级 3)                                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                      │
│  │  Baidu   │  │ Tencent  │  │ Alibaba  │                      │
│  └──────────┘  └──────────┘  └──────────┘                      │
│                                                                   │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    实际 API 调用                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  Google Gemini 2.0 Flash                                         │
│  https://generativelanguage.googleapis.com/...                  │
│                                                                   │
│  Cloudflare Workers AI                                           │
│  https://api.cloudflare.com/.../llama-3.2-11b-vision-instruct  │
│                                                                   │
│  HuggingFace Inference API                                       │
│  https://api-inference.huggingface.co/...                       │
│                                                                   │
│  ... (其他提供商)                                                │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 故障转移流程图

```
开始
  │
  ▼
┌─────────────────┐
│ 用户发起请求    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ callWithFailover│
│ (尝试次数 = 1)  │
└────────┬────────┘
         │
         ▼
┌─────────────────────────┐
│ selectApiProvider       │
│ • 检查能力匹配          │
│ • 检查健康状态          │
│ • 排除已失败的          │
│ • 跳过泄露的密钥        │
└────────┬────────────────┘
         │
         ▼
┌─────────────────┐      ┌─────────────────┐
│ 选中提供商?     │─NO──▶│ 返回错误        │
└────────┬────────┘      │ "无可用提供商"  │
         │YES            └─────────────────┘
         ▼
┌─────────────────┐
│ 调用 API        │
│ (30秒超时)      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐      ┌─────────────────┐
│ 调用成功?       │─YES─▶│ 更新健康状态    │
└────────┬────────┘      │ (healthy=true)  │
         │NO             └────────┬────────┘
         │                        │
         ▼                        ▼
┌─────────────────┐      ┌─────────────────┐
│ 更新健康状态    │      │ 返回成功结果    │
│ (healthy=false) │      │ + 元数据        │
└────────┬────────┘      └─────────────────┘
         │
         ▼
┌─────────────────┐
│ 检测错误类型    │
├─────────────────┤
│ • 密钥泄露?     │─YES─▶ 标记 leaked=true
│ • 可重试?       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐      ┌─────────────────┐
│ 还有重试次数?   │─NO──▶│ 返回错误        │
└────────┬────────┘      │ "所有提供商失败"│
         │YES            └─────────────────┘
         │
         ▼
┌─────────────────┐
│ 等待 1 秒       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 尝试次数 += 1   │
└────────┬────────┘
         │
         └──────────┐
                    │
         ┌──────────┘
         │
         ▼
    (回到选择提供商)
```

---

## 🎯 能力匹配矩阵

| 提供商 | 图像分析 | 图像修改 | 文本翻译 | 优先级 |
|--------|:--------:|:--------:|:--------:|:------:|
| Google Gemini | ✅ | ✅ | ✅ | 🥇 主用 |
| 讯飞星火 | ✅ | ❌ | ✅ | 🥇 主用 |
| Cloudflare | ✅ | ❌ | ✅ | 🥈 备用 |
| HuggingFace | ✅ | ❌ | ✅ | 🥈 备用 |
| DeepSeek | ✅ | ❌ | ❌ | 🥈 备用 |
| Baidu | ✅ | ❌ | ✅ | 🥉 后备 |
| Tencent | ✅ | ❌ | ❌ | 🥉 后备 |
| Alibaba | ✅ | ❌ | ❌ | 🥉 后备 |

**说明**：
- ✅ 支持该功能
- ❌ 不支持该功能
- 🥇 主用：首选提供商
- 🥈 备用：主用失败时使用
- 🥉 后备：最后的选择

---

## 📊 健康状态数据结构

```javascript
{
  provider: {
    healthy: boolean,        // 是否健康
    lastCheck: timestamp,    // 最后检查时间
    errorCount: number,      // 连续错误次数
    leaked: boolean,         // 是否检测到密钥泄露
    leakDetectedAt: timestamp, // 泄露检测时间
    lastError: string        // 最后的错误信息
  }
}
```

### 状态转换图

```
┌─────────────┐
│   初始化    │
│ healthy=true│
│ errorCount=0│
└──────┬──────┘
       │
       ▼
┌─────────────┐     成功调用      ┌─────────────┐
│   健康状态  │◀─────────────────│   使用中    │
│ healthy=true│                   │             │
│ errorCount=0│                   └──────┬──────┘
└──────┬──────┘                          │
       │                                 │
       │                          调用失败
       │                                 │
       │                                 ▼
       │                        ┌─────────────┐
       │                        │   错误累计  │
       │                        │ errorCount++│
       │                        └──────┬──────┘
       │                               │
       │                               │
       │                    errorCount >= 3?
       │                               │
       │                               ▼
       │                        ┌─────────────┐
       └───────────────────────▶│  不健康状态 │
                                │healthy=false│
                                └──────┬──────┘
                                       │
                                       │
                            检测到密钥泄露?
                                       │
                                       ▼
                                ┌─────────────┐
                                │  泄露状态   │
                                │ leaked=true │
                                │ (永久禁用)  │
                                └─────────────┘
```

---

## 🔍 错误检测与分类

### 错误分类树

```
API 错误
├── 可重试错误
│   ├── 网络错误
│   │   ├── timeout (超时)
│   │   ├── ECONNRESET (连接重置)
│   │   ├── ETIMEDOUT (连接超时)
│   │   └── ENOTFOUND (DNS 错误)
│   └── 服务器错误
│       ├── 503 (服务不可用)
│       ├── 502 (网关错误)
│       └── 429 (请求过多)
│
└── 致命错误 (不重试)
    ├── 认证错误
    │   ├── 401 (未授权)
    │   ├── 403 (禁止访问)
    │   └── API key invalid
    └── 安全错误
        ├── API key leaked (密钥泄露)
        ├── Key compromised (密钥被攻破)
        └── Key revoked (密钥被撤销)
```

### 错误处理策略

| 错误类型 | 重试 | 切换提供商 | 标记状态 | 用户提示 |
|---------|:----:|:----------:|:--------:|:--------:|
| 网络超时 | ✅ | ✅ | 不健康 | 无 |
| 服务不可用 | ✅ | ✅ | 不健康 | 无 |
| 认证失败 | ❌ | ✅ | 不健康 | 无 |
| 密钥泄露 | ❌ | ✅ | 泄露 | 警告 |
| 所有失败 | ❌ | ❌ | - | 错误 |

---

## 🎬 实际执行示例

### 示例 1: 正常执行（第一次成功）

```
时间轴:
0ms   │ 用户上传图片
      │
10ms  │ callWithFailover 启动
      │ └─ 尝试 1/3
      │
20ms  │ selectApiProvider
      │ └─ 选中: google (主用)
      │
30ms  │ 调用 Google Gemini API
      │
2000ms│ Google API 响应成功
      │
2010ms│ updateApiHealth(google, true)
      │
2020ms│ 返回结果给用户
      │ └─ { data, provider: "google", attempts: 1 }
```

**日志输出**：
```
🔄 Attempt 1/3: Using provider google for imageAnalysis
✅ Success with provider: google
```

---

### 示例 2: 故障转移（第一次失败，第二次成功）

```
时间轴:
0ms   │ 用户上传图片
      │
10ms  │ callWithFailover 启动
      │ └─ 尝试 1/3
      │
20ms  │ selectApiProvider
      │ └─ 选中: google (主用)
      │
30ms  │ 调用 Google Gemini API
      │
30s   │ 超时！
      │
30010ms│ updateApiHealth(google, false, "timeout")
      │
30020ms│ 等待 1 秒
      │
31020ms│ 尝试 2/3
      │
31030ms│ selectApiProvider
      │ └─ 排除: google
      │ └─ 选中: cloudflare (备用)
      │
31040ms│ 调用 Cloudflare API
      │
33000ms│ Cloudflare API 响应成功
      │
33010ms│ updateApiHealth(cloudflare, true)
      │
33020ms│ 返回结果给用户
      │ └─ { data, provider: "cloudflare", attempts: 2 }
```

**日志输出**：
```
🔄 Attempt 1/3: Using provider google for imageAnalysis
❌ Error with provider google: Request timeout after 30000ms
🔄 Switching to next available provider...
🔄 Attempt 2/3: Using provider cloudflare for imageAnalysis
✅ Success with provider: cloudflare
```

---

### 示例 3: 密钥泄露检测（自动切换）

```
时间轴:
0ms   │ 用户请求去水印
      │
10ms  │ callWithFailover 启动
      │ └─ 尝试 1/3
      │
20ms  │ selectApiProvider
      │ └─ 选中: google (唯一支持)
      │
30ms  │ 调用 Google Gemini API
      │
500ms │ Google API 响应错误
      │ └─ "API key was reported as leaked"
      │
510ms │ detectApiKeyLeak 检测到泄露
      │
520ms │ updateApiHealth(google, false, "leaked")
      │ └─ 标记: leaked=true
      │
530ms │ 🚨 安全警报
      │ └─ "CRITICAL: API key leak detected!"
      │
540ms │ 等待 1 秒
      │
1540ms│ 尝试 2/3
      │
1550ms│ selectApiProvider
      │ └─ 跳过: google (leaked)
      │ └─ 无可用提供商
      │
1560ms│ 返回错误
      │ └─ "No available providers for imageModification"
```

**日志输出**：
```
🔄 Attempt 1/3: Using provider google for imageModification
❌ Error with provider google: API key was reported as leaked
🚨 CRITICAL: API key leak detected for google!
🔒 Security Alert: google API key may have been compromised
💡 Recommendation: Immediately rotate the google API key
🔄 Switching to next available provider...
🔄 Attempt 2/3: No available providers
❌ All providers failed for imageModification
```

---

## 📈 性能指标

### 关键性能指标 (KPI)

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 成功率 | > 99% | 请求成功的比例 |
| 平均响应时间 | < 3s | 从请求到响应的平均时间 |
| 故障转移时间 | < 2s | 切换到备用提供商的时间 |
| 最大重试次数 | 3 | 单次请求的最大尝试次数 |
| 超时时间 | 30s | 单次 API 调用的超时时间 |

### 性能优化

1. **并发请求**：支持多个请求同时处理
2. **智能缓存**：可添加响应缓存（未实现）
3. **预热机制**：定期检查 API 健康状态
4. **负载均衡**：在多个健康提供商间分配请求

---

## 🔐 安全机制

### 多层安全保护

```
┌─────────────────────────────────────┐
│        密钥泄露检测                  │
│  • 实时监控 API 响应                │
│  • 自动标记泄露的密钥                │
│  • 永久禁用泄露的提供商              │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│        健康状态隔离                  │
│  • 不健康的提供商自动跳过            │
│  • 错误计数自动重置                  │
│  • 恢复后自动重新启用                │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│        超时保护                      │
│  • 30 秒请求超时                    │
│  • 防止长时间阻塞                    │
│  • 自动取消超时请求                  │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│        错误隔离                      │
│  • 单个提供商错误不影响其他          │
│  • 自动故障转移                      │
│  • 完整的错误日志                    │
└─────────────────────────────────────┘
```

---

## 🎯 总结

### 核心优势

1. **高可用性**：多提供商冗余，单点故障不影响服务
2. **自动恢复**：检测到错误自动切换，无需人工干预
3. **用户无感**：整个故障转移过程对用户完全透明
4. **安全保护**：自动检测和隔离泄露的 API 密钥
5. **实时监控**：完整的健康状态跟踪和报告

### 技术特点

- ✅ 模块化设计
- ✅ 易于扩展
- ✅ 完整的错误处理
- ✅ 详细的日志记录
- ✅ 企业级可靠性

---

**这就是 PixelGenie 的智能故障转移系统！** 🚀

