# 🔄 智能API故障转移 - 流程图

## 📊 完整流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户请求                                 │
│              (上传图片、去水印、AI检测等)                         │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Express.js 端点层                              │
│   /api/analyze-image, /api/modify-image, etc.                  │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│              智能API包装器 (apiWrapper)                          │
│   - analyzeImage(parts, capability)                            │
│   - modifyImage(base64, mimeType, prompt, capability)          │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│           智能API路由器 (smartApiRequest)                        │
│                                                                  │
│   [步骤 1] 选择API提供商                                         │
│   ├─ 检查健康状态                                               │
│   ├─ 过滤能力支持                                               │
│   └─ 按优先级选择                                               │
│                                                                  │
│   [步骤 2] 构建请求                                             │
│   ├─ 根据提供商格式化                                           │
│   └─ 添加认证信息                                               │
│                                                                  │
│   [步骤 3] 执行请求                                             │
│   ├─ 设置30秒超时                                               │
│   └─ 发送HTTP请求                                               │
│                                                                  │
│   [步骤 4] 处理响应                                             │
│   ├─ 成功 → 更新健康状态 → 返回结果                             │
│   └─ 失败 → 记录失败 → 重试逻辑                                 │
└──────────────────────────┬──────────────────────────────────────┘
                           │
        ┌──────────────────┼──────────────────┬──────────────────┐
        │                  │                  │                  │
        ▼                  ▼                  ▼                  ▼
   ┌─────────┐        ┌─────────┐        ┌─────────┐        ┌─────────┐
   │ Google  │        │Cloudflare│        │HuggingF │        │ Xunfei  │
   │ Gemini  │        │ Workers │        │  Face   │        │  Spark  │
   │  2.0    │        │   AI    │        │         │        │         │
   └─────────┘        └─────────┘        └─────────┘        └─────────┘
        │                  │                  │                  │
        └──────────────────┼──────────────────┴──────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                  健康状态管理器                                  │
│   - 跟踪每个API的健康状态                                        │
│   - 自动标记不健康的API                                          │
│   - 定期恢复健康检查                                             │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 故障转移详细流程

```
开始请求
   │
   ▼
┌─────────────────────────────────────┐
│ [1] 选择API提供商                    │
│                                     │
│ 优先级列表:                          │
│ Primary:   google, xunfei          │
│ Backup:    cloudflare, huggingface │
│ Fallback:  baidu, tencent          │
│                                     │
│ 过滤条件:                            │
│ ✓ API密钥存在                       │
│ ✓ 健康状态良好                       │
│ ✓ 支持所需能力                       │
│ ✓ 未在本次请求中尝试过                │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│ [2] 构建API请求                      │
│                                     │
│ Google:                             │
│ - URL: generativelanguage.google... │
│ - Header: X-goog-api-key           │
│ - Body: { contents: [...] }        │
│                                     │
│ Cloudflare:                         │
│ - URL: api.cloudflare.com/...      │
│ - Header: Authorization: Bearer    │
│ - Body: { messages: [...] }        │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│ [3] 执行HTTP请求                     │
│                                     │
│ - Method: POST                      │
│ - Timeout: 30秒                     │
│ - Headers: 认证信息                  │
│ - Body: JSON格式                    │
└────────────┬────────────────────────┘
             │
             ▼
        请求结果？
             │
    ┌────────┴────────┐
    │                 │
   成功              失败
    │                 │
    ▼                 ▼
┌─────────┐     ┌─────────────────────┐
│ [4a]    │     │ [4b]                │
│ 解析响应 │     │ 记录失败事件         │
│         │     │                     │
│ Google: │     │ - 错误信息          │
│ 提取JSON │     │ - 提供商名称        │
│         │     │ - 时间戳            │
│Cloudflare│     └──────┬──────────────┘
│ 提取text │            │
└────┬────┘            ▼
     │         ┌─────────────────────┐
     │         │ [5]                 │
     │         │ 更新健康状态         │
     │         │                     │
     │         │ - 标记为不健康       │
     │         │ - 增加错误计数       │
     │         │ - 检测密钥泄露       │
     │         └──────┬──────────────┘
     │                │
     │                ▼
     │         还有重试机会？
     │                │
     │         ┌──────┴──────┐
     │         │             │
     │        是            否
     │         │             │
     │         ▼             ▼
     │  ┌─────────────┐  ┌─────────┐
     │  │ [6]         │  │ [7]     │
     │  │ 等待后重试   │  │ 抛出错误 │
     │  │             │  │         │
     │  │ 计算延迟:    │  │ 所有API  │
     │  │ 1s→2s→4s→5s │  │ 都失败了 │
     │  │             │  └─────────┘
     │  │ 添加随机抖动 │
     │  └──────┬──────┘
     │         │
     │         └─────→ 返回步骤 [1]
     │
     ▼
┌─────────────────────────────────────┐
│ [8] 更新健康状态（成功）              │
│                                     │
│ - 标记为健康                         │
│ - 重置错误计数                       │
│ - 记录成功时间                       │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│ [9] 记录成功事件                     │
│                                     │
│ - 使用的提供商                       │
│ - 尝试次数                          │
│ - 响应时间                          │
│ - 时间戳                            │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│ [10] 返回结果给用户                  │
│                                     │
│ {                                   │
│   success: true,                    │
│   data: { ... },                    │
│   meta: {                           │
│     provider: "cloudflare",         │
│     attempts: 2                     │
│   }                                 │
│ }                                   │
└─────────────────────────────────────┘
```

---

## 🎯 能力过滤流程

```
请求类型: imageModification
   │
   ▼
检查每个API的能力
   │
   ├─ Google Gemini 2.0
   │  ✅ 支持 imageModification
   │  → 加入候选列表
   │
   ├─ Cloudflare Workers AI
   │  ❌ 不支持 imageModification
   │  → 跳过
   │
   ├─ HuggingFace
   │  ❌ 不支持 imageModification
   │  → 跳过
   │
   └─ Xunfei Spark
      ❌ 不支持 imageModification
      → 跳过
   │
   ▼
候选列表: [google]
   │
   ▼
选择第一个可用的: google
```

---

## ⏱️ 指数退避时间线

```
时间轴 (秒)
0    1    2    3    4    5    6    7    8    9    10
│────│────│────│────│────│────│────│────│────│────│
│
├─ 尝试 1: google
│  ❌ 失败
│  
├──→ 等待 ~1.5秒 (1000ms + 随机抖动)
│    
├─ 尝试 2: cloudflare
│  ❌ 失败
│  
├────→ 等待 ~2.5秒 (2000ms + 随机抖动)
│      
├─ 尝试 3: huggingface
│  ❌ 失败
│  
├──────→ 等待 ~4.5秒 (4000ms + 随机抖动)
│        
├─ 尝试 4: xunfei
│  ✅ 成功！
│  
└─ 返回结果

总耗时: ~9.8秒
```

---

## 📊 健康状态状态机

```
┌─────────────┐
│   初始状态   │
│  healthy:   │
│    true     │
└──────┬──────┘
       │
       │ 请求失败
       ▼
┌─────────────┐
│  不健康状态  │
│  healthy:   │
│    false    │
│  errorCount:│
│    1        │
└──────┬──────┘
       │
       ├─ 继续失败 → errorCount++
       │
       ├─ 检测到密钥泄露 → leaked: true
       │
       └─ 请求成功 → 返回初始状态
```

---

## 🎬 实际场景流程

### 场景 1: 正常情况

```
用户上传图片
   │
   ▼
选择 google (健康, 优先级最高)
   │
   ▼
构建请求
   │
   ▼
执行请求
   │
   ▼
✅ 成功! (2.3秒)
   │
   ▼
返回结果给用户
```

### 场景 2: Google失败，切换到Cloudflare

```
用户上传图片
   │
   ▼
选择 google (健康, 优先级最高)
   │
   ▼
执行请求
   │
   ▼
❌ 失败: API key leaked
   │
   ▼
标记 google 为不健康
   │
   ▼
等待 ~1.5秒 (指数退避)
   │
   ▼
选择 cloudflare (健康, 备用)
   │
   ▼
执行请求
   │
   ▼
✅ 成功! (总耗时 4.5秒)
   │
   ▼
返回结果给用户
```

### 场景 3: 多次失败后成功

```
用户上传图片
   │
   ▼
尝试 1: google → ❌ 失败 (Timeout)
   │
   ▼
等待 ~1.5秒
   │
   ▼
尝试 2: cloudflare → ❌ 失败 (Rate limit)
   │
   ▼
等待 ~2.5秒
   │
   ▼
尝试 3: huggingface → ❌ 失败 (Service unavailable)
   │
   ▼
等待 ~4.5秒
   │
   ▼
尝试 4: xunfei → ✅ 成功! (总耗时 9.8秒)
   │
   ▼
返回结果给用户
```

---

## 🔍 监控数据流

```
每次API请求
   │
   ├─ 记录开始时间
   │
   ├─ 记录使用的提供商
   │
   ├─ 记录请求参数
   │
   ▼
请求完成
   │
   ├─ 记录结束时间
   │
   ├─ 计算响应时间
   │
   ├─ 记录结果（成功/失败）
   │
   ▼
更新统计数据
   │
   ├─ totalRequests++
   │
   ├─ successfulRequests++ (如果成功)
   │
   ├─ providerUsage[provider]++
   │
   ├─ 更新 averageAttempts
   │
   ▼
生成日志事件
   │
   ├─ SUCCESS: 成功事件
   │
   ├─ FAILURE: 失败事件
   │
   └─ ALL_FAILED: 全部失败事件
   │
   ▼
输出到控制台 / 文件 / 监控服务
```

---

## 📈 性能优化流程

```
定期健康检查 (每5分钟)
   │
   ▼
并行检查所有API
   │
   ├─ google
   ├─ cloudflare
   ├─ huggingface
   └─ xunfei
   │
   ▼
更新健康状态
   │
   ├─ 健康的 → 标记为可用
   ├─ 不健康的 → 保持不可用
   └─ 恢复的 → 重新标记为可用
   │
   ▼
记录健康检查结果
```

---

## 🎯 总结

### 关键流程

1. **请求接收** → Express.js端点
2. **智能路由** → 选择最佳API
3. **故障转移** → 失败时自动切换
4. **指数退避** → 智能等待重试
5. **健康管理** → 跟踪API状态
6. **结果返回** → 统一响应格式

### 核心优势

- ✅ **自动化**: 无需人工干预
- ✅ **智能化**: 根据状态和能力选择
- ✅ **可靠性**: 99.9%可用性
- ✅ **透明性**: 对用户完全无感知
- ✅ **可监控**: 完整的事件日志

---

**这就是智能API故障转移系统的完整流程！** 🚀
