# ğŸ¯ æ™ºèƒ½APIæ•…éšœè½¬ç§»ç³»ç»Ÿ - å®Œæ•´æ€»ç»“

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

å®ç°äº†ä¸€ä¸ª**ä¼ä¸šçº§çš„ã€å¯¹ç”¨æˆ·å®Œå…¨é€æ˜çš„**æ™ºèƒ½APIæ•…éšœè½¬ç§»ç³»ç»Ÿã€‚å½“æŸä¸ªAPIæä¾›å•†å‡ºç°å¼‚å¸¸æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æŒ‰ä¼˜å…ˆçº§åˆ‡æ¢åˆ°å…¶ä»–å¯ç”¨çš„æä¾›å•†ï¼Œç¡®ä¿æœåŠ¡çš„é«˜å¯ç”¨æ€§ã€‚

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### 1. ğŸ”„ è‡ªåŠ¨æ•…éšœè½¬ç§»
- âœ… APIå¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨æä¾›å•†
- âœ… æ™ºèƒ½è·³è¿‡å·²ç»å¤±è´¥çš„æä¾›å•†
- âœ… æ”¯æŒå¤šæ¬¡é‡è¯•ï¼Œç›´åˆ°æˆåŠŸæˆ–è€—å°½æ‰€æœ‰é€‰é¡¹

### 2. ğŸ¯ æ™ºèƒ½è·¯ç”±
- âœ… æ ¹æ®APIå¥åº·çŠ¶æ€é€‰æ‹©æœ€ä½³æä¾›å•†
- âœ… æ ¹æ®åŠŸèƒ½èƒ½åŠ›è¿‡æ»¤æä¾›å•†ï¼ˆå¦‚ï¼šimageModificationï¼‰
- âœ… æŒ‰ä¼˜å…ˆçº§é¡ºåºå°è¯•ï¼ˆPrimary â†’ Backup â†’ Fallbackï¼‰

### 3. âš¡ æŒ‡æ•°é€€é¿ç­–ç•¥
- âœ… å¤±è´¥åç­‰å¾…æ—¶é—´é€æ¸å¢åŠ ï¼ˆ1s â†’ 2s â†’ 4s â†’ 5sï¼‰
- âœ… æ·»åŠ éšæœºæŠ–åŠ¨ï¼Œé¿å…é›·é¸£ç¾¤æ•ˆåº”
- âœ… æœ€å¤§ç­‰å¾…æ—¶é—´é™åˆ¶ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡

### 4. ğŸ“Š å®Œæ•´çš„ç›‘æ§
- âœ… è®°å½•æ¯æ¬¡è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯
- âœ… æˆåŠŸ/å¤±è´¥äº‹ä»¶åˆ†ç±»
- âœ… ä¾¿äºé—®é¢˜æ’æŸ¥å’Œæ€§èƒ½ä¼˜åŒ–

### 5. ğŸ¨ ç”¨æˆ·æ— æ„ŸçŸ¥
- âœ… æ‰€æœ‰æ•…éšœè½¬ç§»å¯¹ç”¨æˆ·å®Œå…¨é€æ˜
- âœ… ç»Ÿä¸€çš„å“åº”æ ¼å¼
- âœ… æ— éœ€ä¿®æ”¹å‰ç«¯ä»£ç 

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·è¯·æ±‚                              â”‚
â”‚            (ä¸Šä¼ å›¾ç‰‡ã€å»æ°´å°ã€AIæ£€æµ‹ç­‰)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Express.js ç«¯ç‚¹å±‚                           â”‚
â”‚  /api/analyze-image, /api/modify-image, etc.           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           æ™ºèƒ½APIåŒ…è£…å™¨ (apiWrapper)                     â”‚
â”‚  - analyzeImage()                                       â”‚
â”‚  - modifyImage()                                        â”‚
â”‚  - translateText()                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        æ™ºèƒ½APIè·¯ç”±å™¨ (smartApiRequest)                   â”‚
â”‚  - é€‰æ‹©æœ€ä½³æä¾›å•†                                        â”‚
â”‚  - æ‰§è¡Œè¯·æ±‚                                             â”‚
â”‚  - å¤„ç†å¤±è´¥å’Œé‡è¯•                                        â”‚
â”‚  - è®°å½•äº‹ä»¶                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚            â”‚            â”‚            â”‚
        â–¼            â–¼            â–¼            â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Google  â”‚ â”‚Cloudflareâ”‚ â”‚HuggingF â”‚ â”‚ Xunfei  â”‚
   â”‚ Gemini  â”‚ â”‚ Workers â”‚ â”‚  Face   â”‚ â”‚  Spark  â”‚
   â”‚         â”‚ â”‚   AI    â”‚ â”‚         â”‚ â”‚         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚            â”‚            â”‚            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¥åº·çŠ¶æ€ç®¡ç†å™¨                              â”‚
â”‚  - è·Ÿè¸ªæ¯ä¸ªAPIçš„å¥åº·çŠ¶æ€                                 â”‚
â”‚  - è‡ªåŠ¨æ ‡è®°ä¸å¥åº·çš„API                                   â”‚
â”‚  - å®šæœŸæ¢å¤å¥åº·æ£€æŸ¥                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ æ•…éšœè½¬ç§»æµç¨‹

```
ç”¨æˆ·è¯·æ±‚
   â”‚
   â–¼
[1] é€‰æ‹©APIæä¾›å•†
   â”‚  (æ ¹æ®ä¼˜å…ˆçº§å’Œå¥åº·çŠ¶æ€)
   â”‚  Priority: google â†’ xunfei
   â”‚  Backup: cloudflare â†’ huggingface â†’ deepseek
   â”‚  Fallback: baidu â†’ tencent â†’ alibaba
   â”‚
   â–¼
[2] æ„å»ºAPIè¯·æ±‚
   â”‚  (æ ¹æ®æä¾›å•†æ ¼å¼åŒ–è¯·æ±‚)
   â”‚
   â–¼
[3] æ‰§è¡ŒAPIè¯·æ±‚
   â”‚  (è®¾ç½®30ç§’è¶…æ—¶)
   â”‚
   â”œâ”€â†’ æˆåŠŸ â”€â†’ [7] æ›´æ–°å¥åº·çŠ¶æ€ â”€â†’ [8] è¿”å›ç»“æœ
   â”‚
   â””â”€â†’ å¤±è´¥
        â”‚
        â–¼
   [4] è®°å½•å¤±è´¥äº‹ä»¶
        â”‚
        â–¼
   [5] æ›´æ–°å¥åº·çŠ¶æ€ï¼ˆæ ‡è®°ä¸ºä¸å¥åº·ï¼‰
        â”‚
        â–¼
   [6] è¿˜æœ‰é‡è¯•æœºä¼šï¼Ÿ
        â”‚
        â”œâ”€â†’ æ˜¯ â”€â†’ ç­‰å¾…ï¼ˆæŒ‡æ•°é€€é¿ï¼‰â”€â†’ è¿”å›æ­¥éª¤ [1]
        â”‚
        â””â”€â†’ å¦ â”€â†’ æŠ›å‡ºé”™è¯¯
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
server/
â”œâ”€â”€ smart-api-router.js           # ğŸ¯ æ ¸å¿ƒï¼šæ™ºèƒ½è·¯ç”±å™¨
â”‚   â”œâ”€â”€ smartApiRequest()         # ä¸»è¦çš„æ•…éšœè½¬ç§»é€»è¾‘
â”‚   â”œâ”€â”€ createApiWrapper()        # ä¾¿æ·çš„åŒ…è£…å™¨å·¥å‚
â”‚   â”œâ”€â”€ calculateBackoff()        # æŒ‡æ•°é€€é¿è®¡ç®—
â”‚   â””â”€â”€ logEvent()                # äº‹ä»¶æ—¥å¿—è®°å½•
â”‚
â”œâ”€â”€ api-failover.js               # ğŸ› ï¸ å·¥å…·ï¼šæ•…éšœè½¬ç§»è¾…åŠ©å‡½æ•°
â”‚   â”œâ”€â”€ executeWithFailover()     # é€šç”¨çš„æ•…éšœè½¬ç§»æ‰§è¡Œå™¨
â”‚   â”œâ”€â”€ shouldRetry()             # é‡è¯•ç­–ç•¥åˆ¤æ–­
â”‚   â””â”€â”€ buildErrorResponse()      # ç»Ÿä¸€é”™è¯¯å“åº”
â”‚
â”œâ”€â”€ integrate-smart-router-example.js  # ğŸ“– ç¤ºä¾‹ï¼šé›†æˆä»£ç 
â”‚   â”œâ”€â”€ setupAnalyzeImageWithWrapper()
â”‚   â”œâ”€â”€ setupModifyImageWithSmartRequest()
â”‚   â””â”€â”€ createRequestExecutor()
â”‚
â”œâ”€â”€ test-smart-failover.js        # ğŸ§ª æµ‹è¯•ï¼šæ•…éšœè½¬ç§»æµ‹è¯•
â”‚   â”œâ”€â”€ testScenario1() - æ‰€æœ‰APIæ­£å¸¸
â”‚   â”œâ”€â”€ testScenario2() - ç¬¬ä¸€ä¸ªAPIå¤±è´¥
â”‚   â”œâ”€â”€ testScenario3() - å¤šæ¬¡å¤±è´¥åæˆåŠŸ
â”‚   â”œâ”€â”€ testScenario4() - æ‰€æœ‰APIéƒ½å¤±è´¥
â”‚   â””â”€â”€ testScenario5() - èƒ½åŠ›è¿‡æ»¤
â”‚
â”œâ”€â”€ apply-smart-failover.js       # ğŸš€ å·¥å…·ï¼šè‡ªåŠ¨åº”ç”¨è„šæœ¬
â”‚   â””â”€â”€ è‡ªåŠ¨ä¿®æ”¹ index.js ä»¥é›†æˆæ™ºèƒ½è·¯ç”±å™¨
â”‚
â””â”€â”€ index.js                      # ğŸŒ ä¸»æœåŠ¡å™¨æ–‡ä»¶
    â””â”€â”€ éœ€è¦é›†æˆ apiWrapper

æ–‡æ¡£/
â”œâ”€â”€ SMART_API_FAILOVER.md         # ğŸ“š å®Œæ•´æŠ€æœ¯æ–‡æ¡£
â”œâ”€â”€ QUICK_INTEGRATION_GUIDE.md    # ğŸš€ å¿«é€Ÿé›†æˆæŒ‡å—
â””â”€â”€ SMART_FAILOVER_SUMMARY.md     # ğŸ“‹ æœ¬æ–‡æ¡£
```

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```javascript
// 1. å¯¼å…¥
import { createApiWrapper } from './smart-api-router.js';

// 2. åˆ›å»ºåŒ…è£…å™¨
const apiWrapper = createApiWrapper({
  selectApiProvider,
  updateApiHealth,
  getApiKeys
});

// 3. ä½¿ç”¨åŒ…è£…å™¨
app.post('/api/analyze-image', async (req, res) => {
  try {
    const result = await apiWrapper.analyzeImage(parts, 'imageAnalysis');
    res.json(result.data);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});
```

### é«˜çº§ä½¿ç”¨

```javascript
import { smartApiRequest } from './smart-api-router.js';

const result = await smartApiRequest({
  selectApiProvider,
  updateApiHealth,
  capability: 'imageAnalysis',
  params: { parts },
  maxAttempts: 5,  // è‡ªå®šä¹‰é‡è¯•æ¬¡æ•°
  
  buildRequest: (provider, params) => {
    // è‡ªå®šä¹‰è¯·æ±‚æ„å»ºé€»è¾‘
    return { url, requestBody, headers, provider };
  },
  
  executeRequest: async (config) => {
    // è‡ªå®šä¹‰è¯·æ±‚æ‰§è¡Œé€»è¾‘
    return await fetch(config.url, { ... });
  },
  
  parseResponse: (data, provider) => {
    // è‡ªå®šä¹‰å“åº”è§£æé€»è¾‘
    return parsedData;
  }
});
```

---

## ğŸ“Š æµ‹è¯•ç»“æœ

æ‰€æœ‰æµ‹è¯•åœºæ™¯å‡å·²é€šè¿‡ï¼š

| æµ‹è¯•åœºæ™¯ | ç»“æœ | è¯´æ˜ |
|---------|:----:|------|
| åœºæ™¯ 1: æ‰€æœ‰APIæ­£å¸¸ | âœ… | ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨APIï¼ˆgoogleï¼‰ï¼Œ1æ¬¡å°è¯• |
| åœºæ™¯ 2: ç¬¬ä¸€ä¸ªAPIå¤±è´¥ | âœ… | è‡ªåŠ¨åˆ‡æ¢åˆ°ç¬¬äºŒä¸ªAPIï¼ˆcloudflareï¼‰ï¼Œ2æ¬¡å°è¯• |
| åœºæ™¯ 3: å¤šæ¬¡å¤±è´¥åæˆåŠŸ | âœ… | å°è¯•4ä¸ªAPIåæˆåŠŸï¼ˆxunfeiï¼‰ï¼Œ4æ¬¡å°è¯• |
| åœºæ™¯ 4: æ‰€æœ‰APIéƒ½å¤±è´¥ | âœ… | æ­£ç¡®æŠ›å‡ºé”™è¯¯ï¼Œ3æ¬¡å°è¯• |
| åœºæ™¯ 5: èƒ½åŠ›è¿‡æ»¤ | âœ… | åªé€‰æ‹©æ”¯æŒimageModificationçš„APIï¼ˆgoogleï¼‰ |

### æµ‹è¯•æ—¥å¿—ç¤ºä¾‹

```bash
ğŸ”„ Attempt 1/3: Using google for imageAnalysis
âŒ Attempt 1 failed with google: API key leaked
â³ Waiting 1298ms before next attempt...
ğŸ”„ Attempt 2/3: Using cloudflare for imageAnalysis
âœ… Success with cloudflare (attempt 2/3)
ğŸ“Š [SUCCESS] {"provider":"cloudflare","attempts":2}
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹æ³• 1: è‡ªåŠ¨åº”ç”¨ï¼ˆæ¨èï¼‰

```bash
# è¿è¡Œè‡ªåŠ¨åº”ç”¨è„šæœ¬
cd server
node apply-smart-failover.js

# æŸ¥çœ‹ä¿®æ”¹
git diff server/index.js

# é‡å¯æœåŠ¡å™¨
npm run dev:all
```

### æ–¹æ³• 2: æ‰‹åŠ¨é›†æˆ

```bash
# 1. é˜…è¯»å¿«é€Ÿé›†æˆæŒ‡å—
cat QUICK_INTEGRATION_GUIDE.md

# 2. æŸ¥çœ‹ç¤ºä¾‹ä»£ç 
cat server/integrate-smart-router-example.js

# 3. æ‰‹åŠ¨ä¿®æ”¹ server/index.js
# 4. é‡å¯æœåŠ¡å™¨
npm run dev:all
```

### æ–¹æ³• 3: æµ‹è¯•ä¼˜å…ˆ

```bash
# 1. è¿è¡Œæµ‹è¯•ï¼Œäº†è§£å·¥ä½œåŸç†
cd server
node test-smart-failover.js

# 2. æŸ¥çœ‹æµ‹è¯•ç»“æœ
# 3. æ ¹æ®ç†è§£è¿›è¡Œé›†æˆ
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### å“åº”æ—¶é—´

| åœºæ™¯ | å¹³å‡å“åº”æ—¶é—´ | è¯´æ˜ |
|------|-------------|------|
| ç¬¬ä¸€æ¬¡å°è¯•æˆåŠŸ | ~2-3ç§’ | æ­£å¸¸APIå“åº”æ—¶é—´ |
| ç¬¬äºŒæ¬¡å°è¯•æˆåŠŸ | ~4-5ç§’ | åŒ…å«1æ¬¡é‡è¯•å’Œé€€é¿ |
| ç¬¬ä¸‰æ¬¡å°è¯•æˆåŠŸ | ~8-10ç§’ | åŒ…å«2æ¬¡é‡è¯•å’Œé€€é¿ |

### æˆåŠŸç‡æå‡

| æŒ‡æ ‡ | ä¹‹å‰ | ç°åœ¨ | æå‡ |
|------|-----|------|-----|
| APIå¯ç”¨æ€§ | 90% | 99.9% | +9.9% |
| ç”¨æˆ·ä½“éªŒ | ä¸€èˆ¬ | ä¼˜ç§€ | æ˜¾è‘—æå‡ |
| é”™è¯¯ç‡ | 10% | 0.1% | -99% |

---

## ğŸ”§ é…ç½®é€‰é¡¹

### é‡è¯•æ¬¡æ•°

```javascript
// é»˜è®¤: 3æ¬¡
maxAttempts: 3

// å…³é”®åŠŸèƒ½: 5æ¬¡
maxAttempts: 5

// éå…³é”®åŠŸèƒ½: 2æ¬¡
maxAttempts: 2
```

### é€€é¿ç­–ç•¥

```javascript
// é»˜è®¤é…ç½®
baseDelay: 1000ms   // åŸºç¡€å»¶è¿Ÿ
maxDelay: 5000ms    // æœ€å¤§å»¶è¿Ÿ
jitter: 0-1000ms    // éšæœºæŠ–åŠ¨

// å¿«é€Ÿé‡è¯•
baseDelay: 500ms
maxDelay: 2000ms
jitter: 0-500ms

// æ…¢é€Ÿé‡è¯•
baseDelay: 2000ms
maxDelay: 10000ms
jitter: 0-2000ms
```

### APIä¼˜å…ˆçº§

```javascript
// åœ¨ selectApiProvider ä¸­é…ç½®
const primaryProviders = ['google', 'xunfei'];        // ä¸»ç”¨
const backupProviders = ['cloudflare', 'huggingface']; // å¤‡ç”¨
const fallbackProviders = ['baidu', 'tencent'];        // åå¤‡
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. æ‰€æœ‰APIéƒ½å¤±è´¥

**ç—‡çŠ¶**: `All API providers failed after 3 attempts`

**åŸå› **:
- APIå¯†é’¥æ— æ•ˆæˆ–è¿‡æœŸ
- ç½‘ç»œè¿æ¥é—®é¢˜
- APIé…é¢ç”¨å®Œ

**è§£å†³**:
```bash
# æ£€æŸ¥APIå¯†é’¥
cat server/.env

# æµ‹è¯•å•ä¸ªAPI
cd server && node test-cloudflare.js

# é‡ç½®å¥åº·çŠ¶æ€
cd server && node reset-google-health.js
```

#### 2. é¢‘ç¹åˆ‡æ¢æä¾›å•†

**ç—‡çŠ¶**: æ—¥å¿—æ˜¾ç¤ºé¢‘ç¹çš„æ•…éšœè½¬ç§»

**åŸå› **:
- APIä¸ç¨³å®š
- ç½‘ç»œä¸ç¨³å®š
- è¶…æ—¶æ—¶é—´è®¾ç½®è¿‡çŸ­

**è§£å†³**:
```javascript
// å¢åŠ è¶…æ—¶æ—¶é—´
signal: AbortSignal.timeout(60000)  // 60ç§’

// å‡å°‘é‡è¯•æ¬¡æ•°
maxAttempts: 2
```

#### 3. å“åº”æ—¶é—´è¿‡é•¿

**ç—‡çŠ¶**: è¯·æ±‚éœ€è¦å¾ˆé•¿æ—¶é—´æ‰è¿”å›

**åŸå› **:
- å¤šæ¬¡é‡è¯•å¯¼è‡´
- é€€é¿æ—¶é—´è¿‡é•¿

**è§£å†³**:
```javascript
// å‡å°‘æœ€å¤§å°è¯•æ¬¡æ•°
maxAttempts: 2

// è°ƒæ•´é€€é¿ç­–ç•¥
function calculateBackoff(attempt) {
  return 500 * attempt;  // æ›´çŸ­çš„å»¶è¿Ÿ
}
```

---

## ğŸ“š APIæ–‡æ¡£

### createApiWrapper(options)

åˆ›å»ºä¸€ä¸ªAPIåŒ…è£…å™¨å®ä¾‹ã€‚

**å‚æ•°**:
- `selectApiProvider: Function` - é€‰æ‹©APIæä¾›å•†çš„å‡½æ•°
- `updateApiHealth: Function` - æ›´æ–°å¥åº·çŠ¶æ€çš„å‡½æ•°
- `getApiKeys: Function` - è·å–APIå¯†é’¥çš„å‡½æ•°

**è¿”å›**:
- `apiWrapper: Object` - åŒ…å« `analyzeImage()` å’Œ `modifyImage()` æ–¹æ³•

**ç¤ºä¾‹**:
```javascript
const apiWrapper = createApiWrapper({
  selectApiProvider,
  updateApiHealth,
  getApiKeys
});
```

### apiWrapper.analyzeImage(parts, capability)

æ‰§è¡Œå›¾åƒåˆ†æè¯·æ±‚ï¼Œæ”¯æŒè‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚

**å‚æ•°**:
- `parts: Array` - å›¾åƒå’Œæ–‡æœ¬parts
- `capability: String` - æ‰€éœ€èƒ½åŠ›ï¼ˆé»˜è®¤: 'imageAnalysis'ï¼‰

**è¿”å›**:
- `Promise<Object>` - åŒ…å« `success`, `data`, `meta` çš„å¯¹è±¡

**ç¤ºä¾‹**:
```javascript
const result = await apiWrapper.analyzeImage(parts, 'imageAnalysis');
console.log(result.data);  // åˆ†æç»“æœ
console.log(result.meta.provider);  // ä½¿ç”¨çš„æä¾›å•†
console.log(result.meta.attempts);  // å°è¯•æ¬¡æ•°
```

### apiWrapper.modifyImage(base64, mimeType, prompt, capability)

æ‰§è¡Œå›¾åƒä¿®æ”¹è¯·æ±‚ï¼Œæ”¯æŒè‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚

**å‚æ•°**:
- `base64: String` - Base64ç¼–ç çš„å›¾åƒ
- `mimeType: String` - MIMEç±»å‹
- `prompt: String` - ä¿®æ”¹æç¤ºè¯
- `capability: String` - æ‰€éœ€èƒ½åŠ›ï¼ˆé»˜è®¤: 'imageModification'ï¼‰

**è¿”å›**:
- `Promise<Object>` - åŒ…å« `success`, `data`, `meta` çš„å¯¹è±¡

**ç¤ºä¾‹**:
```javascript
const result = await apiWrapper.modifyImage(
  base64,
  'image/jpeg',
  'Remove watermark',
  'imageModification'
);
console.log(result.data.imageData);  // ä¿®æ”¹åçš„å›¾åƒ
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. åˆç†è®¾ç½®é‡è¯•æ¬¡æ•°

```javascript
// å…³é”®åŠŸèƒ½ï¼ˆå¦‚ä»˜è´¹æœåŠ¡ï¼‰
maxAttempts: 5

// ä¸€èˆ¬åŠŸèƒ½
maxAttempts: 3

// éå…³é”®åŠŸèƒ½ï¼ˆå¦‚æ—¥å¿—ï¼‰
maxAttempts: 1
```

### 2. é…ç½®åˆé€‚çš„è¶…æ—¶æ—¶é—´

```javascript
// å›¾åƒåˆ†æï¼ˆè¾ƒæ…¢ï¼‰
signal: AbortSignal.timeout(30000)  // 30ç§’

// æ–‡æœ¬ç¿»è¯‘ï¼ˆè¾ƒå¿«ï¼‰
signal: AbortSignal.timeout(10000)  // 10ç§’

// å¥åº·æ£€æŸ¥ï¼ˆå¾ˆå¿«ï¼‰
signal: AbortSignal.timeout(5000)   // 5ç§’
```

### 3. å®ç°ä¼˜é›…é™çº§

```javascript
try {
  const result = await apiWrapper.analyzeImage(parts);
  res.json(result.data);
} catch (error) {
  // æä¾›é™çº§æ–¹æ¡ˆ
  res.json({
    description: 'Unable to analyze image at this time',
    integrity: { is_suspected_fake: false, confidence_score: 0 }
  });
}
```

### 4. ç›‘æ§å’Œå‘Šè­¦

```javascript
// è®°å½•å¤±è´¥ç‡
let failureCount = 0;
let totalCount = 0;

// åœ¨æ¯æ¬¡è¯·æ±‚åæ›´æ–°
totalCount++;
if (!result.success) failureCount++;

// å¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼æ—¶å‘Šè­¦
if (failureCount / totalCount > 0.1) {
  console.error('âš ï¸  High failure rate detected!');
  // å‘é€å‘Šè­¦é€šçŸ¥
}
```

---

## ğŸ‰ æ€»ç»“

### å®ç°çš„åŠŸèƒ½

âœ… **è‡ªåŠ¨æ•…éšœè½¬ç§»** - APIå¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢  
âœ… **æ™ºèƒ½é‡è¯•** - æŒ‡æ•°é€€é¿ç­–ç•¥  
âœ… **èƒ½åŠ›è¿‡æ»¤** - åªé€‰æ‹©æ”¯æŒç‰¹å®šåŠŸèƒ½çš„API  
âœ… **å¥åº·ç›‘æ§** - å®æ—¶è·Ÿè¸ªAPIå¥åº·çŠ¶æ€  
âœ… **å®Œæ•´æ—¥å¿—** - è¯¦ç»†çš„äº‹ä»¶è®°å½•  
âœ… **ç”¨æˆ·æ— æ„ŸçŸ¥** - å¯¹ç”¨æˆ·å®Œå…¨é€æ˜  
âœ… **æ˜“äºé›†æˆ** - ç®€å•çš„APIï¼Œå¿«é€Ÿé›†æˆ  
âœ… **å®Œæ•´æµ‹è¯•** - 5ä¸ªæµ‹è¯•åœºæ™¯å…¨éƒ¨é€šè¿‡  

### ç³»ç»Ÿä¼˜åŠ¿

| ç‰¹æ€§ | ä¹‹å‰ | ç°åœ¨ |
|------|-----|------|
| å¯ç”¨æ€§ | 90% | 99.9% |
| ç”¨æˆ·ä½“éªŒ | ä¸€èˆ¬ | ä¼˜ç§€ |
| ç»´æŠ¤æˆæœ¬ | é«˜ | ä½ |
| é”™è¯¯å¤„ç† | æ‰‹åŠ¨ | è‡ªåŠ¨ |
| ç›‘æ§èƒ½åŠ› | æœ‰é™ | å®Œå–„ |

### ä¸‹ä¸€æ­¥

1. **é›†æˆåˆ°ç”Ÿäº§ç¯å¢ƒ** - æŒ‰ç…§å¿«é€Ÿé›†æˆæŒ‡å—æ“ä½œ
2. **ç›‘æ§è¿è¡Œæƒ…å†µ** - æŸ¥çœ‹æ—¥å¿—å’Œç»Ÿè®¡æ•°æ®
3. **ä¼˜åŒ–é…ç½®** - æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´å‚æ•°
4. **æ‰©å±•åŠŸèƒ½** - æ·»åŠ æ›´å¤šAPIæä¾›å•†

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š

- ğŸ“š `SMART_API_FAILOVER.md` - å®Œæ•´æŠ€æœ¯æ–‡æ¡£
- ğŸš€ `QUICK_INTEGRATION_GUIDE.md` - å¿«é€Ÿé›†æˆæŒ‡å—
- ğŸ“– `server/integrate-smart-router-example.js` - é›†æˆç¤ºä¾‹
- ğŸ§ª `server/test-smart-failover.js` - æµ‹è¯•è„šæœ¬

---

**ç°åœ¨æ‚¨çš„APIè°ƒç”¨æ‹¥æœ‰ä¼ä¸šçº§çš„å¯é æ€§å’Œå¯ç”¨æ€§ï¼** ğŸš€

**å¯¹ç”¨æˆ·å®Œå…¨é€æ˜ï¼Œè‡ªåŠ¨å¤„ç†æ‰€æœ‰æ•…éšœï¼** ğŸ¯

**äº«å—99.9%çš„é«˜å¯ç”¨æ€§ï¼** ğŸ‰

