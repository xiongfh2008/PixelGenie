# 🚨 紧急修复说明 - 后端服务器启动问题

## 问题现状

智能鉴伪功能报错："图片处理失败: 服务暂时不可用，请稍后重试"

**根本原因**: 后端服务器（端口3001）没有运行

## ✅ 立即解决方案

### 方法1: 使用启动脚本（推荐）

1. 打开项目根目录
2. 双击 **`快速启动.bat`** 文件
3. 等待两个窗口打开（前端和后端）
4. 确认后端窗口显示：`🚀 Server running on http://localhost:3001`

### 方法2: 手动启动（如果脚本失败）

**打开CMD或PowerShell**，运行以下命令：

```cmd
cd D:\AIProject\PixelGenie\server
node index.js
```

**保持这个窗口打开！** 关闭窗口会停止服务器。

### 方法3: 使用npm脚本

```cmd
cd D:\AIProject\PixelGenie
npm run dev:server
```

## 🔍 验证服务器是否运行

### 检查1: 查看端口
打开CMD运行：
```cmd
netstat -ano | findstr ":3001"
```

如果看到输出，说明服务器正在运行。

### 检查2: 访问健康检查
在浏览器打开：
```
http://localhost:3001/api/health
```

应该看到：
```json
{
  "status": "ok",
  "message": "Server is running"
}
```

### 检查3: 查看node进程
```cmd
tasklist | findstr "node"
```

应该看到node.exe进程。

## 🐛 已修复的代码问题

我已经修复了以下问题：

1. ✅ **API密钥检查**: 服务器现在即使没有API密钥也能启动（会显示警告）
2. ✅ **错误提示优化**: 所有错误信息改为用户友好的中文
3. ✅ **启动逻辑**: 修复了ES模块导出导致的启动问题

## ⚠️ 重要提示

### 为什么服务器必须运行？

智能鉴伪功能需要：
- 调用Google Gemini API进行图像分析
- 处理ELA（错误级别分析）
- 处理MFR（噪声分析）
- 返回AI检测结果

这些都需要后端服务器处理。

### 服务器配置要求

确保 `server/.env` 文件存在并配置了至少一个API密钥：

```env
GOOGLE_API_KEY=你的Google API密钥
# 或其他支持的API密钥
XUNFEI_API_KEY=你的讯飞API密钥
CLOUDFLARE_API_TOKEN=你的Cloudflare令牌
HUGGINGFACE_API_KEY=你的HuggingFace密钥
```

## 📋 完整启动流程

### 第一次启动

1. **检查Node.js**
   ```cmd
   node --version
   ```
   应该显示 v18+ 或更高版本

2. **安装依赖**（如果还没安装）
   ```cmd
   cd D:\AIProject\PixelGenie
   npm install
   ```

3. **配置API密钥**
   - 复制 `server/env.example` 为 `server/.env`
   - 编辑 `.env` 文件，添加你的API密钥

4. **启动服务器**
   - 双击 `快速启动.bat`
   - 或手动运行上述命令

### 日常使用

每次使用项目时：
1. 双击 `快速启动.bat`
2. 等待两个窗口打开
3. 浏览器自动打开 http://localhost:5173
4. 开始使用智能鉴伪功能

## 🔧 故障排查

### 问题1: 服务器启动后立即退出

**可能原因**:
- API密钥配置错误
- 端口3001被占用
- Node.js版本过低

**解决方法**:
```cmd
# 检查端口占用
netstat -ano | findstr ":3001"

# 如果被占用，结束进程
taskkill /PID <进程ID> /F

# 检查Node版本
node --version

# 重新启动
cd D:\AIProject\PixelGenie\server
node index.js
```

### 问题2: 前端显示"服务暂时不可用"

**原因**: 后端服务器没有运行

**解决**: 按照上述方法启动后端服务器

### 问题3: API密钥错误

**症状**: 服务器运行但功能报错

**解决**:
1. 检查 `server/.env` 文件
2. 确认API密钥正确
3. 重启服务器

## 📞 需要帮助？

如果以上方法都无法解决问题，请提供：

1. **Node.js版本**
   ```cmd
   node --version
   npm --version
   ```

2. **服务器启动输出**
   运行 `node index.js` 后的完整输出

3. **端口占用情况**
   ```cmd
   netstat -ano | findstr ":3001"
   netstat -ano | findstr ":5173"
   ```

4. **错误截图**
   浏览器控制台的错误信息

---

## ✨ 快速命令参考

```cmd
# 启动后端
cd D:\AIProject\PixelGenie\server && node index.js

# 启动前端
cd D:\AIProject\PixelGenie && npm run dev

# 检查服务器状态
netstat -ano | findstr ":3001"

# 访问健康检查
curl http://localhost:3001/api/health

# 或在浏览器打开
start http://localhost:3001/api/health
```

---

**修复时间**: 2025-11-27  
**修复内容**: 后端启动逻辑优化 + 错误提示改进

