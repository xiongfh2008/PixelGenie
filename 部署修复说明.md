# 🚀 Vercel & Cloudflare 部署修复说明

## 问题修复

### 问题1: Vercel部署 - "图片处理失败: 处理失败，请重试"
**原因**: 后端API路由配置不正确，Vercel无法找到API处理函数

**修复内容**:
1. ✅ 创建了 `api/index.js` - Vercel Serverless Function入口
2. ✅ 更新了 `vercel.json` 配置
3. ✅ 修改了前端API调用逻辑，在生产环境使用相对路径

### 问题2: Cloudflare部署 - "Dewatermark Failed: Image editing failed"  
**原因**: Cloudflare Pages没有后端API处理函数

**修复内容**:
1. ✅ 创建了 `functions/api/[[path]].js` - Cloudflare Pages Function
2. ✅ 实现了完整的API路由处理
3. ✅ 修改了前端API调用逻辑

## 📋 Vercel 部署步骤

### 1. 配置环境变量

在 Vercel 项目设置中添加以下环境变量：

```
GOOGLE_API_KEY=你的Google API密钥
CLOUDFLARE_API_TOKEN=你的Cloudflare令牌（可选）
CLOUDFLARE_ACCOUNT_ID=你的Cloudflare账号ID（可选）
HUGGINGFACE_API_KEY=你的HuggingFace密钥（可选）
XUNFEI_API_KEY=你的讯飞密钥（可选）
XUNFEI_APP_ID=你的讯飞AppID（可选）
XUNFEI_API_SECRET=你的讯飞Secret（可选）
NODE_ENV=production
```

### 2. 部署设置

**Build Command**: `npm run build`  
**Output Directory**: `dist`  
**Install Command**: `npm install`

### 3. 验证部署

访问: `https://your-app.vercel.app/api/health`

应该返回:
```json
{
  "status": "ok",
  "message": "Vercel serverless function is running"
}
```

## 📋 Cloudflare Pages 部署步骤

### 1. 配置环境变量

在 Cloudflare Pages 项目设置中添加：

```
GOOGLE_API_KEY=你的Google API密钥
CLOUDFLARE_API_TOKEN=你的Cloudflare令牌（可选）
CLOUDFLARE_ACCOUNT_ID=你的Cloudflare账号ID（可选）
HUGGINGFACE_API_KEY=你的HuggingFace密钥（可选）
```

### 2. 构建设置

**Build command**: `npm run build`  
**Build output directory**: `dist`  
**Root directory**: `/`

### 3. 验证部署

访问: `https://your-app.pages.dev/api/health`

应该返回:
```json
{
  "status": "ok",
  "message": "Cloudflare Pages function is running"
}
```

## 🔧 本地测试

### 测试 Vercel 部署

```bash
# 安装 Vercel CLI
npm i -g vercel

# 本地运行
vercel dev

# 访问
http://localhost:3000
```

### 测试 Cloudflare 部署

```bash
# 安装 Wrangler CLI
npm i -g wrangler

# 本地运行
wrangler pages dev dist

# 访问
http://localhost:8788
```

## ✅ 修复验证清单

### Vercel
- [ ] 环境变量已配置
- [ ] `api/index.js` 文件存在
- [ ] `vercel.json` 已更新
- [ ] 部署成功
- [ ] `/api/health` 返回正常
- [ ] 智能鉴伪功能正常工作

### Cloudflare
- [ ] 环境变量已配置
- [ ] `functions/api/[[path]].js` 文件存在
- [ ] 部署成功
- [ ] `/api/health` 返回正常
- [ ] 智能鉴伪功能正常工作

## 🐛 故障排查

### Vercel 问题

**问题**: API返回404
**解决**: 检查 `vercel.json` 路由配置是否正确

**问题**: 超时错误
**解决**: 增加函数超时时间（已在vercel.json中设置为60秒）

**问题**: 内存不足
**解决**: 增加函数内存（已在vercel.json中设置为1024MB）

### Cloudflare 问题

**问题**: 函数未找到
**解决**: 确保 `functions/api/[[path]].js` 路径正确

**问题**: 环境变量未加载
**解决**: 在Cloudflare Pages设置中重新添加环境变量

**问题**: CORS错误
**解决**: 已在函数中添加CORS头，如仍有问题检查浏览器控制台

## 📝 注意事项

1. **API密钥安全**: 
   - 不要在代码中硬编码API密钥
   - 使用平台的环境变量功能
   - 定期轮换密钥

2. **性能优化**:
   - Vercel: 已设置60秒超时和1024MB内存
   - Cloudflare: 使用边缘计算，响应更快

3. **成本控制**:
   - 监控API调用次数
   - 设置使用限制
   - 使用免费额度

## 🎯 部署后测试

1. 访问健康检查端点
2. 上传测试图片
3. 使用智能鉴伪功能
4. 检查浏览器控制台是否有错误
5. 验证所有功能正常工作

---

**修复完成时间**: 2025-11-27  
**修复内容**: Vercel和Cloudflare部署API路由配置

