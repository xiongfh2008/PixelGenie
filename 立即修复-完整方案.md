# 🚨 立即修复：无法连接到服务器

## 问题诊断

**错误信息**：`Error processing image: 无法连接到服务器。请确保后端服务器正在运行（npm run dev:server）`

**根本原因**：
1. ❌ 后端服务器没有运行（端口 3001）
2. ✅ **已修复**：`vite.config.ts` 缺少 API 代理配置

---

## ✅ 已完成的修复

### 1. 修复了 Vite 配置

已在 `vite.config.ts` 中添加 API 代理：

```typescript
server: {
  host: true,
  port: 5173,
  proxy: {
    '/api': {
      target: 'http://localhost:3001',
      changeOrigin: true,
      secure: false
    }
  }
}
```

这样前端的 `/api/*` 请求会自动代理到后端 `http://localhost:3001`。

---

## 🎯 立即操作步骤

### 步骤 1：启动后端服务器

**请按以下任一方法启动后端：**

#### 方法 A：双击启动脚本（推荐）

双击项目根目录的：**`启动后端-带日志.bat`**

这会打开一个新的 CMD 窗口并显示详细日志。

#### 方法 B：手动启动

1. 按 `Win + R`，输入 `cmd`，回车
2. 运行以下命令：

```cmd
cd /d D:\AIProject\PixelGenie\server
node index.js
```

#### 方法 C：使用 PowerShell

```powershell
cd D:\AIProject\PixelGenie\server
node index.js
```

---

### 步骤 2：确认后端启动成功

后端窗口应该显示：

```
🚀 Server running on http://localhost:3001
📡 API Health Check: http://localhost:3001/api/health
🎨 Frontend should connect to: http://localhost:3001
✅ Available API providers: google, cloudflare, xunfei, ...
🔑 Active provider: google
```

**如果看到这些输出，说明后端启动成功！**

---

### 步骤 3：重启前端服务器

由于修改了 `vite.config.ts`，需要重启前端：

1. 在前端终端按 `Ctrl + C` 停止
2. 重新运行：

```bash
npm run dev
```

或者在 Cursor 中，停止当前的 `npm run dev` 进程，然后重新运行。

---

### 步骤 4：测试功能

1. 访问 http://localhost:5173
2. 上传一张图片
3. 点击任意功能按钮（智能鉴伪、去水印等）
4. 应该可以正常工作，不再显示"无法连接到服务器"错误

---

## 🔍 验证后端是否运行

### 方法 1：检查端口

```cmd
netstat -ano | findstr :3001
```

如果有输出，说明端口 3001 被占用（后端正在运行）。

### 方法 2：访问健康检查

在浏览器打开：http://localhost:3001/api/health

应该看到 JSON 响应：
```json
{
  "status": "healthy",
  "timestamp": "2025-11-27T...",
  "apis": {
    "google": "healthy",
    "cloudflare": "healthy",
    ...
  }
}
```

### 方法 3：检查进程

```cmd
tasklist | findstr node.exe
```

应该看到至少 2 个 node.exe 进程（一个前端，一个后端）。

---

## 🐛 如果后端仍然无法启动

### 问题 1：端口被占用

```cmd
# 查找占用端口的进程
netstat -ano | findstr :3001

# 结束进程（替换 <PID>）
taskkill /PID <PID> /F
```

### 问题 2：没有任何输出就退出

这可能是代码错误。请检查：

1. **检查 Node.js 版本**：
```cmd
node --version
```
应该是 v18 或更高版本。

2. **重新安装依赖**：
```cmd
cd D:\AIProject\PixelGenie
npm install
```

3. **检查环境变量**：
确保 `server/.env` 文件存在，并至少配置了一个 API 密钥。

### 问题 3：导入错误

如果看到类似 `Cannot find module 'xxx'` 的错误：

```cmd
cd D:\AIProject\PixelGenie
npm install xxx
```

常见缺失的模块：
- `form-data`
- `node-fetch`
- `express`
- `cors`

---

## 📋 完整启动检查清单

- [ ] 后端服务器已启动（CMD 窗口显示 "Server running"）
- [ ] 端口 3001 被占用（`netstat -ano | findstr :3001` 有输出）
- [ ] 健康检查通过（http://localhost:3001/api/health 返回 JSON）
- [ ] 前端服务器已重启（加载了新的 vite.config.ts）
- [ ] 访问 http://localhost:5173 可以看到界面
- [ ] 上传图片不再显示"无法连接到服务器"错误

---

## 🎯 快速命令参考

### 启动后端（CMD）
```cmd
cd /d D:\AIProject\PixelGenie\server
node index.js
```

### 启动前端（新终端）
```cmd
cd /d D:\AIProject\PixelGenie
npm run dev
```

### 检查端口
```cmd
netstat -ano | findstr :3001
netstat -ano | findstr :5173
```

### 测试后端
```cmd
curl http://localhost:3001/api/health
```

或在浏览器打开：http://localhost:3001/api/health

---

## 🌐 访问地址

| 服务 | 地址 | 状态 |
|------|------|------|
| 🎨 前端界面 | http://localhost:5173 | 需要重启 |
| 🔧 后端 API | http://localhost:3001 | 需要启动 |
| 💚 健康检查 | http://localhost:3001/api/health | 需要启动 |

---

## 💡 重要提示

1. **保持后端窗口打开**：关闭会停止服务器
2. **重启前端**：修改了 vite.config.ts 后必须重启前端
3. **两个窗口都要运行**：前端（5173）+ 后端（3001）
4. **查看日志**：后端窗口会显示所有 API 请求和错误

---

## 🆘 仍然无法连接？

如果完成以上所有步骤后仍然无法连接，请提供：

1. **后端启动时的完整输出**（截图或文本）
2. **前端控制台的错误信息**（按 F12 查看）
3. **`netstat -ano | findstr :3001` 的输出**
4. **浏览器访问 http://localhost:3001/api/health 的结果**

---

## ✅ 成功标志

当您看到：

**后端窗口**：
```
🚀 Server running on http://localhost:3001
✅ Available API providers: google, cloudflare, xunfei
```

**前端浏览器**：
- 可以上传图片
- 点击功能按钮有响应
- 不再显示"无法连接到服务器"错误

**恭喜！问题已解决！** 🎉

---

**现在请立即执行：**

1. ✅ 双击 `启动后端-带日志.bat`
2. ✅ 等待看到 "Server running" 消息
3. ✅ 重启前端（Ctrl+C 停止，然后 `npm run dev`）
4. ✅ 访问 http://localhost:5173 测试功能

---

**修复时间**：2025-11-27  
**修复内容**：
- ✅ 添加了 Vite API 代理配置
- ✅ 创建了后端启动脚本
- ✅ 提供了完整的诊断和修复步骤

