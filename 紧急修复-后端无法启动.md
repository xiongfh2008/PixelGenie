# 🚨 紧急修复：后端服务器无法启动

## 问题现象

前端显示错误：
```
Error processing image: 无法连接到服务器。请确保后端服务器正在运行 (npm run dev:server)
```

**原因**：后端服务器（端口 3001）没有运行。

---

## ✅ 立即解决方案

### 方法一：手动启动后端（推荐）

#### 步骤 1：打开新的命令提示符（CMD）

按 `Win + R`，输入 `cmd`，按回车

#### 步骤 2：切换到 server 目录

```cmd
cd /d D:\AIProject\PixelGenie\server
```

#### 步骤 3：启动后端服务器

```cmd
node index.js
```

#### 步骤 4：确认启动成功

您应该看到类似以下输出：
```
🚀 Server running on http://localhost:3001
📡 API Health Check: http://localhost:3001/api/health
🎨 Frontend should connect to: http://localhost:3001
✅ Available API providers: google, cloudflare, xunfei, ...
🔑 Active provider: google
```

如果看到这些输出，说明后端启动成功！

#### 步骤 5：测试功能

返回浏览器 http://localhost:5173，重新上传图片测试功能。

---

### 方法二：使用启动脚本

双击项目根目录的 **`启动后端.bat`** 文件

---

### 方法三：完整重启

双击项目根目录的 **`启动项目.bat`** 文件（会同时启动前端和后端）

---

## 🔍 验证后端是否运行

### 方法 1：检查端口

打开 PowerShell 或 CMD，运行：
```cmd
netstat -ano | findstr :3001
```

如果有输出，说明端口 3001 被占用（后端正在运行）。

### 方法 2：访问健康检查接口

在浏览器打开：http://localhost:3001/api/health

如果看到 JSON 响应，说明后端正在运行：
```json
{
  "status": "healthy",
  "timestamp": "...",
  "apis": { ... }
}
```

### 方法 3：查看任务管理器

1. 按 `Ctrl + Shift + Esc` 打开任务管理器
2. 找到 `Node.js: Server-side JavaScript` 进程
3. 如果有多个 node.exe 进程，说明后端可能在运行

---

## ⚠️ 如果后端启动后立即退出

### 可能原因 1：端口被占用

**解决方法**：
```cmd
# 查找占用 3001 端口的进程
netstat -ano | findstr :3001

# 结束进程（替换 <PID> 为实际进程ID）
taskkill /PID <PID> /F
```

### 可能原因 2：环境变量未配置

**解决方法**：

1. 检查 `server/.env` 文件是否存在
2. 确保至少配置了一个 API 密钥：
   ```
   GOOGLE_API_KEY=您的密钥
   ```

### 可能原因 3：依赖缺失

**解决方法**：
```cmd
cd /d D:\AIProject\PixelGenie
npm install
```

### 可能原因 4：代码错误

**解决方法**：

查看后端启动时的错误信息。如果看到类似以下错误：

- `Cannot find module 'xxx'` → 运行 `npm install`
- `SyntaxError` → 代码有语法错误，需要修复
- `Error: listen EADDRINUSE` → 端口被占用，按方法 1 解决

---

## 📋 完整启动流程

### 1. 启动后端（CMD 窗口 1）

```cmd
cd /d D:\AIProject\PixelGenie\server
node index.js
```

**保持此窗口打开！**

### 2. 启动前端（CMD 窗口 2）

```cmd
cd /d D:\AIProject\PixelGenie
npm run dev
```

**保持此窗口打开！**

### 3. 访问应用

浏览器打开：http://localhost:5173

---

## 🎯 快速检查清单

启动后端后，请确认：

- [ ] CMD 窗口显示 "Server running on http://localhost:3001"
- [ ] 访问 http://localhost:3001/api/health 返回 JSON
- [ ] `netstat -ano | findstr :3001` 有输出
- [ ] 前端不再显示"无法连接到服务器"错误
- [ ] 可以正常上传和处理图片

---

## 💡 提示

1. **不要关闭后端窗口**：关闭窗口会停止后端服务器
2. **保持两个窗口运行**：一个前端（5173），一个后端（3001）
3. **如果修改了代码**：需要重启后端服务器（Ctrl+C 停止，然后重新运行 `node index.js`）
4. **前端会自动重载**：修改前端代码后会自动刷新，无需重启

---

## 🆘 仍然无法启动？

请提供以下信息：

1. **后端启动时的完整输出**（截图或复制文本）
2. **是否看到任何错误信息**
3. **`netstat -ano | findstr :3001` 的输出**
4. **Node.js 版本**：`node --version`

---

## ✅ 成功标志

当您看到：

**后端窗口**：
```
🚀 Server running on http://localhost:3001
```

**前端浏览器**：
- 可以上传图片
- 功能正常工作
- 不再显示"无法连接到服务器"错误

**恭喜！后端已成功启动！** 🎉

---

**立即操作**：

1. 打开 CMD
2. 运行：`cd /d D:\AIProject\PixelGenie\server && node index.js`
3. 保持窗口打开
4. 返回浏览器测试功能

---

**更新时间**：2025-11-27  
**状态**：紧急修复指南

